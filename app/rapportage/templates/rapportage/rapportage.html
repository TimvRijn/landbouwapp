<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>üìä Gebruiksruimte &amp; Bemesting - AgriTech 2100</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  {% set _display_name = session.get('view_as_user_name')
                        or session.get('naam')
                        or session.get('username')
                        or 'Gebruiker' %}

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  {% if not pdf_mode %}
  <!-- Quantum Navigation CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quantum-navigation.css') }}">
  <!-- Quantum Modal CSS (optioneel, maar sluit aan bij rest van app) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quantum-modal.css') }}">
  {% endif %}

  <style>
    :root{
      --quantum-primary:#0f172a;
      --quantum-secondary:#1e293b;
      --quantum-accent:#22c55e;
      --quantum-accent-dark:#16a34a;
      --quantum-accent-soft:rgba(34,197,94,.16);
      --quantum-danger:#ef4444;
      --quantum-danger-soft:rgba(248,113,113,.18);
      --quantum-warning:#eab308;
      --quantum-warning-soft:rgba(234,179,8,.18);
      --quantum-surface:rgba(30,41,59,.9);
      --quantum-surface-soft:rgba(30,41,59,.75);
      --quantum-surface-light:rgba(51,65,85,.9);
      --quantum-text:#f8fafc;
      --quantum-text-muted:rgba(226,232,240,.78);
      --quantum-border:rgba(148,163,184,.32);
      --shadow-quantum:0 24px 60px rgba(15,23,42,.9);
      --shadow-soft:0 18px 42px rgba(15,23,42,.8);
      --border-radius:18px;
      --transition:all .24s cubic-bezier(.4,0,.2,1);
    }
    *{margin:0;padding:0;box-sizing:border-box}

    html,body{
      height:100%;
      background:
        radial-gradient(circle at 0% 0%, #0f172a 0, #020617 45%, #020617 100%);
      color:var(--quantum-text);
      font-family:'Inter',system-ui,sans-serif;
      overflow-x:hidden;
    }
    body::before{
      content:'';position:fixed;inset:0;
      background:
        radial-gradient(circle at 15% 80%, rgba(34,197,94,.2) 0%, transparent 55%),
        radial-gradient(circle at 85% 20%, rgba(59,130,246,.18) 0%, transparent 52%),
        radial-gradient(circle at 50% 40%, rgba(8,47,73,.9) 0%, transparent 60%);
      opacity:.85;
      pointer-events:none;
      z-index:-1;
      mix-blend-mode:screen;
    }

    .container{
      max-width:1400px;
      margin:0 auto;
      padding:40px 24px 40px;
      min-height:100vh;
    }

    /* -------- HEADER -------- */
    .header-row{
      margin-bottom:24px;
      position:relative;
    }
    h1{
      font-size:clamp(2.4rem,4.6vw,3.6rem);
      font-weight:900;
      background:conic-gradient(from 140deg,#22c55e,#4ade80,#22c55e,#16a34a);
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
      letter-spacing:-.03em;
      margin-bottom:6px;
    }
    .header-subtitle{
      font-size:.92rem;
      color:var(--quantum-text-muted);
      max-width:720px;
    }

    .header-row-inner{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }

    .top-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .action-btn{
      border-radius:999px;
      padding:9px 18px;
      font-size:.8rem;
      font-weight:600;
      border:0;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      backdrop-filter:blur(16px);
      white-space:nowrap;
      transition:var(--transition);
    }
    .action-btn.primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#022c22;
      box-shadow:0 14px 35px rgba(16,185,129,.7);
    }
    .action-btn.secondary{
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.4);
      color:var(--quantum-text);
      box-shadow:0 10px 28px rgba(15,23,42,.85);
    }
    .action-btn span.icon{
      font-size:1rem;
    }
    .action-btn:hover{
      transform:translateY(-1px) translateZ(0);
      box-shadow:0 18px 45px rgba(15,23,42,.95);
    }

    /* -------- FILTERS -------- */
    .filter-section{
      background:radial-gradient(circle at 0 0,rgba(34,197,94,.25),transparent 55%),
                 linear-gradient(135deg,rgba(15,23,42,.96),rgba(15,23,42,.93));
      border-radius:var(--border-radius);
      padding:20px 20px 14px;
      margin-bottom:18px;
      border:1px solid rgba(148,163,184,.38);
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }
    .filter-section::before{
      content:'';position:absolute;inset:-1px;
      border-radius:inherit;
      border:1px solid rgba(148,163,184,.25);
      pointer-events:none;
      opacity:.45;
    }

    .filter-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:14px;
      gap:12px;
    }
    .filter-title{
      font-weight:700;
      font-size:.95rem;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .filter-title span.icon{font-size:1.1rem}
    .filter-subtitle{
      font-size:.78rem;
      color:var(--quantum-text-muted);
      margin-top:2px;
    }
    .filter-meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .meta-chip{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      font-size:.72rem;
      color:var(--quantum-text-muted);
      background:rgba(15,23,42,.95);
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .meta-chip span.dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--quantum-accent);
      box-shadow:0 0 8px rgba(34,197,94,.9);
    }

    .filter-grid{
      display:grid;
      grid-template-columns:2.1fr 3.1fr 3fr;
      gap:16px;
      margin-bottom:10px;
    }
    @media(max-width:960px){
      .filter-grid{
        grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      }
    }

    .filter-item label{
      color:var(--quantum-text);
      font-weight:600;
      font-size:.78rem;
      margin-bottom:6px;
      display:block;
    }
    .filter-subtext{
      margin-top:4px;
      font-size:.76rem;
      color:var(--quantum-text-muted);
    }

    /* Jaar ‚Äì pill groep */
    .year-pill-group{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .year-pill{
      position:relative;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      cursor:pointer;
      padding:3px;
      font-size:.78rem;
    }
    .year-pill input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    .year-pill span{
      display:block;
      padding:6px 11px;
      border-radius:999px;
      color:var(--quantum-text-muted);
      transition:var(--transition);
      white-space:nowrap;
    }
    .year-pill input:checked + span{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#022c22;
      font-weight:600;
      box-shadow:0 8px 24px rgba(34,197,94,.65);
    }

    /* Bedrijven ‚Äì chips lijst */
    .bedrijven-list{
      display:flex;
      flex-wrap:wrap;
      gap:9px;
      max-height:180px;
      overflow-y:auto;
      padding:6px 4px;
      border-radius:14px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.35);
    }
    .bedrijf-chip{
      position:relative;
      display:inline-flex;
      align-items:center;
      cursor:pointer;
      font-size:.82rem;
    }
    .bedrijf-chip input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    .bedrijf-name{
      padding:8px 13px;
      border-radius:999px;
      border:1px solid transparent;
      white-space:nowrap;
      background:rgba(15,23,42,1);
      color:var(--quantum-text-muted);
      transition:var(--transition);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .bedrijf-chip input:checked + .bedrijf-name{
      border-color:rgba(34,197,94,.7);
      background:linear-gradient(135deg,rgba(34,197,94,.3),rgba(15,23,42,.98));
      color:var(--quantum-text);
      box-shadow:0 0 0 1px rgba(34,197,94,.4),
                 0 10px 26px rgba(15,23,42,.95);
    }

    @media(max-width:640px){
      .bedrijven-list{
        max-height:220px;
      }
      .bedrijf-chip{
        width:100%;
      }
      .bedrijf-name{
        width:100%;
        justify-content:space-between;
      }
    }

    /* Hoofd-bedrijf ‚Äì lijst */
    .hoofdbedrijf-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:4px;
      max-height:180px;
      overflow-y:auto;
      padding:4px 2px;
      border-radius:14px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.35);
    }
    .hoofdbedrijf-chip{
      position:relative;
      display:flex;
      align-items:center;
      cursor:pointer;
      font-size:.82rem;
    }
    .hoofdbedrijf-chip input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    .hoofdbedrijf-name{
      padding:9px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(15,23,42,1);
      color:var(--quantum-text-muted);
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
      transition:var(--transition);
    }
    .hoofdbedrijf-main{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .hoofdbedrijf-badge{font-size:1.05rem}
    .hoofdbedrijf-sub{
      font-size:.74rem;
      color:var(--quantum-text-muted);
    }
    .hoofdbedrijf-chip input:checked + .hoofdbedrijf-name{
      border-color:rgba(34,197,94,.7);
      background:linear-gradient(135deg,rgba(34,197,94,.3),rgba(15,23,42,.98));
      color:var(--quantum-text);
      box-shadow:0 0 0 1px rgba(34,197,94,.4),
                 0 10px 26px rgba(15,23,42,.98);
    }

    .filter-selected-info{
      margin-top:4px;
      font-size:.76rem;
      color:var(--quantum-text-muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .filter-selected-dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(34,197,94,.9);
      box-shadow:0 0 6px rgba(34,197,94,.9);
    }

    .pill-toggle-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .pill-option{
      position:relative;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.95);
      padding:7px 9px;
      cursor:pointer;
      min-width:0;
      flex:1 1 150px;
      display:flex;
      flex-direction:column;
      gap:2px;
      transition:var(--transition);
      font-size:.78rem;
    }
    .pill-option input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    .pill-title{
      font-weight:600;
      color:var(--quantum-text);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pill-sub{
      font-size:.72rem;
      color:var(--quantum-text-muted);
    }
    .pill-option.active{
      border-color:var(--quantum-accent);
      background:linear-gradient(135deg,rgba(34,197,94,.3),rgba(15,23,42,1));
      box-shadow:0 0 0 1px rgba(34,197,94,.45),
                 0 10px 26px rgba(34,197,94,.6);
    }
    .pill-option.active .pill-title::before{
      content:'‚óè';
      color:var(--quantum-accent);
      font-size:.7rem;
    }

    .filter-buttons{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .btn-filter,.btn-export{
      padding:8px 15px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      font-weight:600;
      font-size:.78rem;
      transition:var(--transition);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-filter{
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      color:#eff6ff;
      box-shadow:0 12px 32px rgba(37,99,235,.7);
    }
    .btn-export{
      background:rgba(15,23,42,.96);
      color:var(--quantum-text);
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 10px 26px rgba(15,23,42,.9);
    }
    .btn-filter:hover,.btn-export:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 36px rgba(15,23,42,.95);
    }

    /* -------- HINT & KPI's -------- */
    .hint-bar{
      margin:0 auto 16px;
      max-width:980px;
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.4);
      background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.94));
      box-shadow:0 20px 55px rgba(15,23,42,1);
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-size:.78rem;
      color:var(--quantum-text-muted);
    }
    .hint-bar-emoji{font-size:1.2rem;margin-top:1px}
    .hint-bar strong{color:var(--quantum-accent)}

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
      margin-bottom:16px;
    }
    @media(max-width:1200px){
      .kpi-grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    @media(max-width:960px){
      .kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:640px){
      .kpi-grid{grid-template-columns:1fr;}
    }

    .kpi-card{
      border-radius:16px;
      padding:10px 12px;
      background:radial-gradient(circle at 0 0,rgba(148,163,184,.4),transparent 55%),
                 linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.96));
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 16px 40px rgba(15,23,42,.95);
      position:relative;
      overflow:hidden;
    }
    .kpi-card.compact-danger{
      background:radial-gradient(circle at 0 0,rgba(248,113,113,.5),transparent 55%),
                 linear-gradient(135deg,rgba(30,41,59,.98),rgba(15,23,42,.98));
      border-color:rgba(248,113,113,.7);
    }
    .kpi-card.n-theme::before,
    .kpi-card.p-theme::before{
      content:'';position:absolute;inset:0;opacity:.14;pointer-events:none;
    }
    .kpi-card.n-theme::before{
      background:radial-gradient(circle at 0 0,rgba(56,189,248,1),transparent 55%);
    }
    .kpi-card.p-theme::before{
      background:radial-gradient(circle at 0 0,rgba(244,114,182,1),transparent 55%);
    }

    .kpi-label{
      font-size:.76rem;
      color:var(--quantum-text-muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:2px;
    }
    .kpi-label span.chip{
      font-size:.7rem;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.98);
    }
    .kpi-value-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:6px;
      position:relative;
      z-index:1;
    }
    .kpi-main{
      font-size:1.25rem;
      font-weight:700;
      letter-spacing:-.03em;
    }
    .kpi-unit{
      font-size:.75rem;
      color:var(--quantum-text-muted);
      margin-left:3px;
    }
    .kpi-sub{
      font-size:.74rem;
      color:var(--quantum-text-muted);
      text-align:right;
    }
    .kpi-trend{
      font-size:.73rem;
      display:inline-flex;
      align-items:center;
      gap:4px;
      margin-top:2px;
    }
    .kpi-trend.good{color:var(--quantum-accent);}
    .kpi-trend.bad{color:var(--quantum-danger);}
    .kpi-bar{
      margin-top:6px;
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,1);
      overflow:hidden;
      border:1px solid rgba(15,23,42,1);
    }
    .kpi-bar-fill{
      height:100%;
      border-radius:inherit;
      background:linear-gradient(90deg,#22c55e,#84cc16,#eab308,#ef4444);
      transform-origin:left center;
    }

    .overview-meta-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .overview-legend{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:.7rem;
      color:var(--quantum-text-muted);
    }
    .legend-chip{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.98);
    }
    .legend-dot{
      width:8px;height:8px;border-radius:999px;
    }
    .legend-dot.green{background:#22c55e;}
    .legend-dot.yellow{background:#eab308;}
    .legend-dot.red{background:#ef4444;}
    .legend-dot.blue{background:#38bdf8;}
    .legend-dot.pink{background:#f472b6;}

    /* -------- TABEL -------- */
    .table-card{
      background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.96));
      border:1px solid rgba(15,23,42,1);
      border-radius:var(--border-radius);
      box-shadow:0 22px 60px rgba(15,23,42,1);
      padding:16px 16px 14px;
    }
    .table-card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .table-card-title{
      font-weight:700;
      font-size:.95rem;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .table-card-title span.icon{font-size:1.1rem}
    .table-card-subtitle{
      font-size:.76rem;
      color:var(--quantum-text-muted);
    }

    .table-responsive{
      width:100%;
      overflow-x:auto;
      border-radius:12px;
      border:1px solid rgba(30,41,59,1);
      background:rgba(15,23,42,1);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
    }
    thead{
      background:linear-gradient(90deg,#020617,#020617);
    }
    th,td{
      padding:7px 9px;
      white-space:nowrap;
    }
    th{
      text-align:left;
      font-weight:600;
      color:rgba(148,163,184,1);
      border-bottom:1px solid rgba(51,65,85,1);
      font-size:.75rem;
    }
    thead tr.group-row th{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:rgba(209,213,219,.9);
      background:#020617;
      border-bottom:1px solid rgba(55,65,81,1);
    }
    .group-n{
      background:linear-gradient(90deg,rgba(56,189,248,.3),rgba(15,23,42,1));
    }
    .group-p{
      background:linear-gradient(90deg,rgba(244,114,182,.3),rgba(15,23,42,1));
    }

    tbody tr:nth-child(even){
      background:#020617;
    }
    tbody tr:nth-child(odd){
      background:#020617;
    }
    td.text-end{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    /* Rood alleen bij N/P te factureren > 0 */
    tr.table-danger{
      background:rgba(127,29,29,.9) !important;
    }
    tr.table-danger td{
      border-top:1px solid rgba(248,113,113,.4);
      border-bottom:1px solid rgba(248,113,113,.4);
    }

    .cell-n{color:#bae6fd;}
    .cell-p{color:#f9a8d4;}
    .cell-strong-red strong{color:#fecaca;}

    .no-data{
      text-align:center;
      padding:40px 20px;
      background:var(--quantum-surface);
      border-radius:var(--border-radius);
      border:2px dashed var(--quantum-border);
      backdrop-filter:blur(20px);
      max-width:700px;
      margin:0 auto;
    }
    .no-data h3{margin-bottom:8px}
    .no-data p{font-size:.9rem;color:var(--quantum-text-muted)}

    .flashes{list-style:none;margin:0 0 8px;padding:0}
    .flash{
      margin-bottom:4px;
      padding:7px 9px;
      border-radius:8px;
      font-size:.78rem;
    }
    .flash-success{
      background:rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.6);
    }
    .flash-error{
      background:rgba(239,68,68,.16);
      border:1px solid rgba(239,68,68,.7);
    }

    @media(max-width:768px){
      .container{padding:24px 14px 30px;}
      .filter-section{padding:16px 14px 12px;}
      .table-card{padding:14px 12px;}
      .table-responsive{font-size:.78rem;}
      .header-row-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .top-actions{
        justify-content:flex-start;
      }
    }

    /* --- KPI SECTIES: STIKSTOF vs FOSFAAT --- */
.kpi-section{
  border-radius:20px;
  padding:14px 16px 16px;
  margin-bottom:18px;
  position:relative;
  overflow:hidden;
  border:1px solid rgba(15,23,42,1);
  box-shadow:0 22px 60px rgba(15,23,42,1);
  backdrop-filter:blur(18px);
}

.kpi-section-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  margin-bottom:12px;
}

.kpi-section-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:1rem;
  font-weight:800;
  letter-spacing:-.02em;
}

.kpi-section-title span.icon{
  font-size:1.35rem;
}

.kpi-section-sub{
  font-size:.78rem;
  color:var(--quantum-text-muted);
}

.kpi-section-meta{
  text-align:right;
  font-size:.75rem;
  color:var(--quantum-text-muted);
}

.kpi-section-n{
  background:radial-gradient(circle at 0 0,rgba(56,189,248,.35),transparent 55%),
             linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.96));
  border-color:rgba(56,189,248,.6);
}

.kpi-section-p{
  background:radial-gradient(circle at 0 0,rgba(244,114,182,.35),transparent 55%),
             linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.96));
  border-color:rgba(244,114,182,.6);
}

/* optionele glow-lijnen bovenaan de sectie */
.kpi-section::before{
  content:'';
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:.25;
  background:linear-gradient(90deg,rgba(148,163,184,.6),transparent 30%,transparent 70%,rgba(148,163,184,.6));
}

/* grid is hetzelfde, maar iets ruimer */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:12px;
}

@media(max-width:1200px){
  .kpi-grid{grid-template-columns:repeat(3,minmax(0,1fr));}
}
@media(max-width:960px){
  .kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
}
@media(max-width:640px){
  .kpi-grid{grid-template-columns:1fr;}
}

/* KPI-kaarten nog duidelijker N vs P */
.kpi-card{
  border-radius:18px;
  padding:10px 12px;
  position:relative;
  overflow:hidden;
  background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.96));
  border:1px solid rgba(30,41,59,1);
  box-shadow:0 18px 44px rgba(15,23,42,.95);
}

/* Dikke gekleurde zijbalk + achtergrondglow per type */
.kpi-card::before{
  content:'';
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:4px;
  opacity:.9;
}

.kpi-card.n-theme{
  border-color:rgba(56,189,248,.85);
  background:
    radial-gradient(circle at 0 0,rgba(56,189,248,.4),transparent 55%),
    linear-gradient(135deg,rgba(15,23,42,.99),rgba(15,23,42,.96));
}
.kpi-card.n-theme::before{
  background:linear-gradient(180deg,#38bdf8,#0ea5e9);
}

.kpi-card.p-theme{
  border-color:rgba(244,114,182,.9);
  background:
    radial-gradient(circle at 0 0,rgba(244,114,182,.45),transparent 55%),
    linear-gradient(135deg,rgba(15,23,42,.99),rgba(15,23,42,.96));
}
.kpi-card.p-theme::before{
  background:linear-gradient(180deg,#f472b6,#ec4899);
}

/* Danger-kaarten blijven rood maar houden hun N/P kleur */
.kpi-card.compact-danger{
  background:
    radial-gradient(circle at 0 0,rgba(248,113,113,.6),transparent 55%),
    linear-gradient(135deg,rgba(30,41,59,.99),rgba(15,23,42,.99));
  border-color:rgba(248,113,113,.8);
}

/* bestaande typografie licht bijgeschaafd */
.kpi-label{
  font-size:.76rem;
  color:var(--quantum-text-muted);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:2px;
}

.kpi-label span.chip{
  font-size:.7rem;
  padding:2px 7px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.5);
  background:rgba(15,23,42,.98);
}

.kpi-value-row{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:6px;
  position:relative;
  z-index:1;
}

.kpi-main{
  font-size:1.3rem;
  font-weight:700;
  letter-spacing:-.03em;
}

.kpi-unit{
  font-size:.75rem;
  color:var(--quantum-text-muted);
  margin-left:3px;
}

.kpi-sub{
  font-size:.74rem;
  color:var(--quantum-text-muted);
  text-align:right;
}

.kpi-trend{
  font-size:.73rem;
  display:inline-flex;
  align-items:center;
  gap:4px;
  margin-top:2px;
}

.kpi-trend.good{color:var(--quantum-accent);}
.kpi-trend.bad{color:var(--quantum-danger);}

.kpi-bar{
  margin-top:6px;
  height:6px;
  border-radius:999px;
  background:rgba(15,23,42,1);
  overflow:hidden;
  border:1px solid rgba(15,23,42,1);
}
.kpi-bar-fill{
  height:100%;
  border-radius:inherit;
  background:linear-gradient(90deg,#22c55e,#84cc16,#eab308,#ef4444);
  transform-origin:left center;
}


.company-kpi-wrapper{
  display:flex;
  flex-direction:column;
  gap:16px;
}

  </style>
</head>
<body>
{% if not pdf_mode %}
  <!-- Quantum Navigation -->
  <nav id="quantumNav"
       data-component="QuantumNavigation"
       data-auto-init="true"
       data-current-page="rapportage"
       data-admin-only="{{ 'true' if session.get('is_admin',0)==1 else 'false' }}"
       data-show-user-profile="true"
       data-user-name="{{ _display_name }}"
       data-user-avatar="{{ _display_name[0]|upper }}"
       data-user-role="{{ 'Admin' if session.get('is_admin',0)==1 else 'Gebruiker' }}">
    <button class="quantum-mobile-btn" id="quantumMobileBtn" aria-label="Menu"></button>
    <span class="quantum-page-label" id="quantumPageLabel" aria-current="page"></span>
    <ul class="quantum-nav-links" id="quantumNavLinks"></ul>
  </nav>
{% endif %}

  <div class="container">
    <!-- HEADER -->
    <div class="header-row">
      <div class="header-row-inner">
        <div>
          <h1 id="pageTitle">Gebruiksruimte &amp; Bemesting</h1>
          <p class="header-subtitle">
            E√©n hypermodern overzicht van N (stikstof) en P (fosfaat): gebruiksruimte, bemesting, dierlijke mest en te factureren hoeveelheden per bedrijf.
          </p>
        </div>
        <div class="top-actions">
          <!-- Vernieuw-actie is niet meer nodig; filters auto-submitten nu -->
          <button class="action-btn secondary" onclick="exportExcel()">
            <span class="icon">üìä</span> Excel
          </button>
          <button class="action-btn primary" onclick="exportPdf()">
            <span class="icon">üßæ</span> PDF-rapport
          </button>
        </div>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="flash flash-{{category}}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- FILTERS -->
<form
  id="rapportForm"
  method="get"
  action="{{ url_for('rapportage.rapportage') }}"
  class="filter-section"
>
  <!-- standaard action=view zodat auto-submit altijd rapport toont -->
  <input type="hidden" name="action" value="view">


      <div class="filter-header">
        <div>
          <div class="filter-title">
            <span class="icon">üéõÔ∏è</span>
            Rapportfilters
          </div>
          <div class="filter-subtitle">
            Kies jaar, bedrijven en hoe je kunstmest wilt verdelen (per bedrijf of gebundeld op een hoofd-bedrijf).
          </div>
        </div>
        <div class="filter-meta">
          {% if selected_jaar %}
          <div class="meta-chip">
            <span class="dot"></span>
            Jaar <strong>{{ selected_jaar }}</strong>
          </div>
          {% endif %}
          <div class="meta-chip">
            <span class="dot"></span>
            {{ geselecteerde_bedrijf_ids|length }} / {{ bedrijven|length }} bedrijven geselecteerd
          </div>
        </div>
      </div>

      <div class="filter-grid">
        <!-- Jaar -->
        <div class="filter-item">
          <label>Jaar</label>
          <div class="year-pill-group">
            {% for jaar in jaren %}
              <label class="year-pill">
                <input type="radio" name="jaar" value="{{ jaar }}" {% if jaar == selected_jaar %}checked{% endif %}>
                <span>{{ jaar }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <!-- Bedrijven -->
        <div class="filter-item">
          <label>Bedrijven</label>
          <div class="bedrijven-list">
            {% for b in bedrijven %}
              <label class="bedrijf-chip">
                <input type="checkbox" name="bedrijf_ids" value="{{ b.id }}"
                {% if b.id|string in geselecteerde_bedrijf_ids %}checked{% endif %}>

                <span class="bedrijf-name">
                  <span>üè¢ {{ b.naam }}</span>
                  {% if b.plaats %}
                    <span style="opacity:.7;font-size:.78rem;">{{ b.plaats }}</span>
                  {% endif %}
                </span>
              </label>
            {% endfor %}
          </div>
          <div class="filter-selected-info">
            <span class="filter-selected-dot"></span>
            <span>
              {{ geselecteerde_bedrijf_ids|length }} bedrijf{% if geselecteerde_bedrijf_ids|length != 1 %}ben{% endif %} geselecteerd
            </span>
          </div>
          <div class="filter-subtext">
            Tik bedrijven aan of uit om ze op te nemen in het rapport.
          </div>
        </div>

        <!-- Hoofd-bedrijf (optioneel, bepaalt of kunstmest wordt gebundeld) -->
        <div class="filter-item">
          <label>Hoofd-bedrijf (optioneel)</label>

          <div class="hoofdbedrijf-list">
            <!-- Geen hoofd-bedrijf = kunstmest blijft per bedrijf -->
            <label class="hoofdbedrijf-chip">
              <input type="radio" name="hoofd_bedrijf_id" value=""
                    {% if not hoofd_bedrijf_id %}checked{% endif %}>

              <span class="hoofdbedrijf-name">
                <span class="hoofdbedrijf-main">
                  <span class="hoofdbedrijf-badge">üö´</span>
                  <span>Geen specifiek hoofd-bedrijf</span>
                </span>
                <span class="hoofdbedrijf-sub">
                  Kunstmest blijft op het bedrijf waar het geboekt is
                </span>
              </span>
            </label>

            {# Alleen bedrijven tonen die in de selectie zitten #}
            {% for b in bedrijven if b.id|string in geselecteerde_bedrijf_ids %}

            <label class="hoofdbedrijf-chip">
            <input type="radio" name="hoofd_bedrijf_id" value="{{ b.id }}"
                  {% if hoofd_bedrijf_id and b.id|string == hoofd_bedrijf_id %}checked{% endif %}>

              <span class="hoofdbedrijf-name">
                <span class="hoofdbedrijf-main">
                  <span class="hoofdbedrijf-badge">üëë</span>
                  <span>
                    {{ b.naam }}
                    {% if b.plaats %}<span style="opacity:.7;">‚Äì {{ b.plaats }}</span>{% endif %}
                  </span>
                </span>
                <span class="hoofdbedrijf-sub">
                  Alle kunstmest bundelen op dit bedrijf
                </span>
              </span>
            </label>
            {% endfor %}
          </div>

          <div class="filter-subtext">
            Kies een hoofd-bedrijf als je alle kunstmest daar wilt bundelen.
            Laat "Geen specifiek hoofd-bedrijf" staan om alles per bedrijf te tonen.
          </div>
        </div>

        </div>
      

      <div class="filter-buttons">
        <!-- Toon rapport knop is verwijderd; rapport wordt nu automatisch gemaakt bij elke wijziging -->
        <button type="button" class="btn-export" onclick="exportExcel()">
          üìä Excel
        </button>
        <button type="button" class="btn-export" onclick="exportPdf()">
          üßæ PDF
        </button>
      </div>
    </form>


    {% if rows %}
      {# ---------- AGGREGATEN VOOR KPI'S (N + P) ---------- #}
      {% set ns = namespace(
        t_toegestaan=0,
        t_bemest=0,
        t_over=0,
        t_af=0,
        t_dierlijk_af=0,
        t_dierlijk_over=0,
        n_dierlijk=0,
        p_toegestaan=0,
        p_bemest=0,
        p_over=0,
        p_af=0,
        p_dierlijk=0,
        overschrijding_count=0,
        p_overschrijding_count=0
      ) %}

      {% for r in rows %}
        {% set ns.t_toegestaan = ns.t_toegestaan + r.n_toegestaan %}
        {% set ns.t_bemest = ns.t_bemest + r.n_bemest_totaal %}
        {% set ns.t_over = ns.t_over + r.n_over %}
        {% set ns.t_af = ns.t_af + r.n_af_te_voeren %}
        {% set ns.t_dierlijk_af = ns.t_dierlijk_af + r.n_org_af_te_voeren %}
        {% set ns.t_dierlijk_over = ns.t_dierlijk_over + r.n_org_over %}
        {% set ns.n_dierlijk = ns.n_dierlijk + r.n_dierlijk_kg %}

        {% set ns.p_toegestaan = ns.p_toegestaan + (r.p_toegestaan or 0) %}
        {% set ns.p_bemest = ns.p_bemest + (r.p_bemest_totaal or 0) %}
        {% set ns.p_over = ns.p_over + (r.p_over or 0) %}
        {% set ns.p_af = ns.p_af + (r.p_af_te_voeren or 0) %}
        {% set ns.p_dierlijk = ns.p_dierlijk + (r.p_dierlijk_kg or 0) %}

        {% if r.n_af_te_voeren > 0 or r.n_org_af_te_voeren > 0 %}
          {% set ns.overschrijding_count = ns.overschrijding_count + 1 %}
        {% endif %}
        {% if r.p_af_te_voeren > 0 %}
          {% set ns.p_overschrijding_count = ns.p_overschrijding_count + 1 %}
        {% endif %}
      {% endfor %}

      {% set benutting = 0 %}
      {% if ns.t_toegestaan > 0 %}
        {% set benutting = (ns.t_bemest / ns.t_toegestaan * 100) %}
      {% endif %}

      {% set p_benutting = 0 %}
      {% if ns.p_toegestaan > 0 %}
        {% set p_benutting = (ns.p_bemest / ns.p_toegestaan * 100) %}
      {% endif %}

      {% set n_dierlijk_benutting = 0 %}
      {% if ns.t_toegestaan > 0 %}
        {% set n_dierlijk_benutting = (ns.n_dierlijk / ns.t_toegestaan * 100) %}
      {% endif %}

      {% set p_dierlijk_benutting = 0 %}
      {% if ns.p_toegestaan > 0 %}
        {% set p_dierlijk_benutting = (ns.p_dierlijk / ns.p_toegestaan * 100) %}
      {% endif %}

        
      <div class="overview-meta-row">

        <div class="table-card-subtitle">
          {{ rows|length }} bedrijf(en) in overzicht ¬∑
          {% set total_overschrijding = ns.overschrijding_count + ns.p_overschrijding_count %}
          {% if total_overschrijding > 0 %}
            {{ total_overschrijding }} overschrijding(en) (N en/of P)
          {% else %}
            geen overschrijdingen
          {% endif %}
        </div>
      </div>

            <!-- PER-BEDRIJF KAARTEN IPV DETAILTABEL -->
      <div class="company-kpi-wrapper">
        {% for r in rows %}
          {# per-bedrijf berekeningen #}
          {% set n_benutting = 0 %}
          {% if r.n_toegestaan > 0 %}
            {% set n_benutting = (r.n_bemest_totaal / r.n_toegestaan * 100) %}
          {% endif %}

          {% set p_benutting_row = 0 %}
          {% if (r.p_toegestaan or 0) > 0 %}
            {% set p_benutting_row = (r.p_bemest_totaal / r.p_toegestaan * 100) %}
          {% endif %}

          {% set n_overschrijding = r.n_af_te_voeren > 0 or r.n_org_af_te_voeren > 0 %}
          {% set p_overschrijding = r.p_af_te_voeren > 0 %}

          <div class="kpi-section company-section">
            <div class="kpi-section-header">
              <div>
                <div class="kpi-section-title">
                  <span class="icon">üè¢</span>
                  <span>{{ r.bedrijf_naam }}</span>
                </div>
                <div class="kpi-section-sub">
                  Jaar {{ r.jaar }} ¬∑ N en P per bedrijf (incl. dierlijk en kunstmest).
                </div>
              </div>
            <div class="kpi-section-meta">
              {% if n_overschrijding or p_overschrijding %}
                <div><strong style="color:#f97373;">‚ö†Ô∏è Overschrijding</strong></div>
              {% else %}
                <div><strong style="color:#4ade80;">‚úÖ Binnen normen</strong></div>
              {% endif %}

              {# totale N- en P-saldo: positief = ruimte, negatief = overschrijding #}
              {% set n_saldo_meta = (r.n_over or 0) - (r.n_af_te_voeren or 0) %}
              {% set p_saldo_meta = (r.p_over or 0) - (r.p_af_te_voeren or 0) %}

              <div>
                N saldo: {{ "%.0f"|format(n_saldo_meta) }} kg<br>
                P saldo: {{ "%.0f"|format(p_saldo_meta) }} kg
              </div>
            </div>

            </div>

            <div class="kpi-grid">
              {# 1. N-gebruiksruimte #}
            <div class="kpi-card n-theme">
              <div class="kpi-label">
                <span>N-gebruiksruimte</span>
                <span class="chip">
                  organisch (dierlijk): {{ "%.0f"|format(r.n_toegestaan_dierlijk) }} kg
                </span>
              </div>
              <div class="kpi-value-row">
                <div>
                  <span class="kpi-main">
                    {{ "%.0f"|format(r.n_toegestaan) }}<span class="kpi-unit">kg N</span>
                  </span>
                </div>
                <div class="kpi-sub">
                  Totale N-ruimte op dit bedrijf.
                </div>
              </div>
            </div>

            {# 2. N totaal bemest ‚Äì uitgesplitst in organische / overige mest #}
            <div class="kpi-card n-theme">
              <div class="kpi-label">
                <span>N totaal bemest</span>
                <span class="chip">
                  {% if n_benutting > 0 %}
                    {{ "%.1f"|format(n_benutting) }}% benut
                  {% else %}
                    0% benut
                  {% endif %}
                </span>
              </div>
              <div class="kpi-value-row">
                <div>
                  <span class="kpi-main">
                    {{ "%.0f"|format(r.n_bemest_totaal) }}<span class="kpi-unit">kg N</span>
                  </span>
                </div>
                <div class="kpi-sub">
                  <div>Organische mest: {{ "%.0f"|format(r.n_dierlijk_kg) }} kg</div>
                  <div>Overige mest: {{ "%.0f"|format(r.n_overige_kg) }} kg</div>
                  <div class="kpi-trend {% if n_benutting <= 100 %}good{% else %}bad{% endif %}">
                    {% if n_benutting <= 100 %}
                      ‚úÖ Binnen N-gebruiksruimte
                    {% else %}
                      ‚ö†Ô∏è {{ "%.1f"|format(n_benutting-100) }}% boven N-ruimte
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="kpi-bar">
                <div class="kpi-bar-fill" style="width:{{ [n_benutting, 160]|min }}%;"></div>
              </div>
            </div>

{# 3. N saldo ‚Äì organisch + totaal (als ¬± saldo) #}
<div class="kpi-card compact-danger n-theme">
  <div class="kpi-label">
    <span>N saldo</span>
    <span class="chip">organisch + totaal</span>
  </div>

  {# totale N-saldo: >0 = ruimte, <0 = overschrijding #}
  {% set n_saldo_totaal = (r.n_over or 0) - (r.n_af_te_voeren or 0) %}
  {# organische mest saldo: >0 = ruimte, <0 = overschrijding #}
  {% set n_saldo_org = (r.n_org_over or 0) - (r.n_org_af_te_voeren or 0) %}

  <div class="kpi-value-row">
    <div>
      <span class="kpi-main">
        {{ "%.0f"|format(n_saldo_totaal) }}<span class="kpi-unit">kg N</span>
      </span>
    </div>
    <div class="kpi-sub">
      <div><strong>Organische mest saldo</strong>:
        {{ "%.0f"|format(n_saldo_org) }} kg
      </div>
      <div class="kpi-trend {% if n_saldo_totaal < 0 %}bad{% else %}good{% endif %}">
        {% if n_saldo_totaal < 0 %}
          üö® N-afvoer nodig op dit bedrijf
        {% else %}
          ‚úÖ Geen N-overschrijding
        {% endif %}
      </div>
    </div>
  </div>
</div>




              <!-- P: gebruiksruimte -->
              <div class="kpi-card p-theme">
                <div class="kpi-label">
                  <span>P-gebruiksruimte</span>
                  <span class="chip">max. P‚ÇÇO‚ÇÖ</span>
                </div>
                <div class="kpi-value-row">
                  <div>
                    <span class="kpi-main">
                      {{ "%.0f"|format(r.p_toegestaan or 0) }}<span class="kpi-unit">kg P‚ÇÇO‚ÇÖ</span>
                    </span>
                  </div>
                  <div class="kpi-sub">
                    Totale fosfaatruimte op dit bedrijf.
                  </div>
                </div>
              </div>

 {# P: totaal bemest ‚Äì uitgesplitst #}
<div class="kpi-card p-theme">
  <div class="kpi-label">
    <span>P totaal bemest</span>
    <span class="chip">
      {% if p_benutting_row > 0 %}
        {{ "%.1f"|format(p_benutting_row) }}% benut
      {% else %}
        0% benut
      {% endif %}
    </span>
  </div>
  <div class="kpi-value-row">
    <div>
      <span class="kpi-main">
        {{ "%.0f"|format(r.p_bemest_totaal or 0) }}<span class="kpi-unit">kg P‚ÇÇO‚ÇÖ</span>
      </span>
    </div>
    <div class="kpi-sub">
      <div>Organische mest: {{ "%.0f"|format(r.p_dierlijk_kg or 0) }} kg P‚ÇÇO‚ÇÖ</div>
      <div>Overige mest: {{ "%.0f"|format(r.p_overige_kg or 0) }} kg P‚ÇÇO‚ÇÖ</div>
      <div class="kpi-trend {% if p_benutting_row <= 100 %}good{% else %}bad{% endif %}">
        {% if p_benutting_row <= 100 %}
          ‚úÖ Binnen P-gebruiksruimte
        {% else %}
          ‚ö†Ô∏è {{ "%.1f"|format(p_benutting_row-100) }}% boven P-ruimte
        {% endif %}
      </div>
    </div>
  </div>
  <div class="kpi-bar">
    <div class="kpi-bar-fill" style="width:{{ [p_benutting_row, 160]|min }}%;"></div>
  </div>
</div>


   {# P: saldo ‚Äì organisch + totaal (als ¬± saldo) #}
<div class="kpi-card compact-danger p-theme">
  <div class="kpi-label">
    <span>P saldo</span>
    <span class="chip">organisch + totaal</span>
  </div>

  {# totale P-saldo: >0 = ruimte, <0 = overschrijding #}
  {% set p_saldo_totaal = (r.p_over or 0) - (r.p_af_te_voeren or 0) %}
  {# organische P-saldo: >0 = ruimte, <0 = overschrijding #}
  {% set p_saldo_org = (r.p_org_over or 0) - (r.p_org_af_te_voeren or 0) %}

  <div class="kpi-value-row">
    <div>
      <span class="kpi-main">
        {{ "%.0f"|format(p_saldo_totaal) }}<span class="kpi-unit">kg P‚ÇÇO‚ÇÖ</span>
      </span>
    </div>
    <div class="kpi-sub">
      <div><strong>Organische mest saldo</strong>:
        {{ "%.0f"|format(p_saldo_org) }} kg P‚ÇÇO‚ÇÖ
      </div>
      <div class="kpi-trend {% if p_saldo_totaal < 0 %}bad{% else %}good{% endif %}">
        {% if p_saldo_totaal < 0 %}
          üö® P-afvoer nodig op dit bedrijf
        {% else %}
          ‚úÖ Geen P-overschrijding
        {% endif %}
      </div>
    </div>
  </div>
</div>



            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      <div class="no-data">
        <h3>üì≠ Geen gegevens gevonden</h3>
        <p>
          Er zijn nog geen gebruiksnormen of bemestingen voor de gekozen filters.
        </p>
      </div>
    {% endif %}
  </div>

{% if not pdf_mode %}
  <!-- Quantum Navigation JavaScript -->
  <script src="{{ url_for('static', filename='js/quantum-navigation.js') }}"></script>
{% endif %}

  <!-- Flask routes naar JS -->
  <script>
    window.setFlaskUrls?.({
      'dashboard.bedrijfsdashboard': '{{ url_for("dashboard.bedrijfsdashboard") }}',
      'bemestingen.bemestingen_nieuw': '{{ url_for("bemestingen.bemestingen_nieuw") }}',
      'bedrijven.bedrijven': '{{ url_for("bedrijven.bedrijven") }}',
      'percelen.percelen': '{{ url_for("percelen.percelen") }}',
      'gebruiksnormen.gebruiksnormen': '{{ url_for("gebruiksnormen.gebruiksnormen") }}',
      'universele_data.universele_data': '{{ url_for("universele_data.universele_data") }}',
      'bemestingen.bemestingen': '{{ url_for("bemestingen.bemestingen") }}',
      'rapportage.rapportage': '{{ url_for("rapportage.rapportage") }}',
      'gebruikers.gebruikers': '{{ url_for("gebruikers.gebruikers") }}',
      'gebruikers.logout': '{{ url_for("gebruikers.logout") }}',
      'gebruikers.view_as': '{{ url_for("gebruikers.view_as") }}',
      'gebruikers.view_as_clear': '{{ url_for("gebruikers.view_as_clear") }}',
      'gebruikers.list_json': '{{ url_for("gebruikers.list_json") }}'
    });
  </script>

  {% if session.get('is_admin', 0) == 1 %}
  <script>
    window.VIEW_AS = {
      enabled: true,
      currentId: {{ session.get('view_as_user_id')|tojson }},
      currentName: {{ session.get('view_as_user_name')|tojson }}
    };
  </script>
  {% endif %}

{% if not pdf_mode %}
  <!-- Quantum Modal JS (optioneel, voor confirm-dialogs in de toekomst) -->
  <script defer src="{{ url_for('static', filename='js/quantum-modal.js') }}"></script>

<script>
  function setActionValue(value) {
    const form = document.getElementById('rapportForm');
    if (!form) return;

    let actionInput = form.querySelector('input[name="action"]');
    if (!actionInput) {
      actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      form.appendChild(actionInput);
    }
    actionInput.value = value;
  }

  function submitWithAction(actionValue) {
    const form = document.getElementById('rapportForm');
    if (!form) return;
    setActionValue(actionValue);
    form.submit();
  }

  function exportExcel() {
    submitWithAction('excel');
  }

  function exportPdf() {
    submitWithAction('pdf');
  }

  function autoSubmitView() {
    submitWithAction('view');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('rapportForm');
    if (!form) return;

    // Jaar (radio's)
    form.querySelectorAll('input[name="jaar"]').forEach(el => {
      el.addEventListener('change', autoSubmitView);
    });

    // Bedrijven (checkboxen)
    form.querySelectorAll('input[name="bedrijf_ids"]').forEach(el => {
      el.addEventListener('change', autoSubmitView);
    });

    // Hoofd-bedrijf (radio's)
    form.querySelectorAll('input[name="hoofd_bedrijf_id"]').forEach(el => {
      el.addEventListener('change', autoSubmitView);
    });
  });
</script>

{% endif %}
</body>
</html>
