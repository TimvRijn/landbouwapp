<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>📊 Dashboard - AgriTech 2100</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Quantum Navigation CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quantum-navigation.css') }}">

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1vcHufUkQmzq5etm1ah12shO0QciskiA&libraries=places,drawing,geometry&callback=initMaps&loading=async" defer></script>

  <style>
    /* ====== Page-specific Quantum Styling ====== */
    :root {
      --quantum-primary:#0f172a;--quantum-secondary:#1e293b;--quantum-accent:#22c55e;--quantum-accent-dark:#16a34a;
      --quantum-surface:rgba(30,41,59,.8);--quantum-surface-light:rgba(51,65,85,.6);--quantum-text:#f8fafc;--quantum-text-muted:rgba(248,250,252,.7);
      --quantum-border:rgba(34,197,94,.2);--shadow-quantum:0 25px 50px -12px rgba(0,0,0,.4);
      --border-radius:16px;--transition:all .3s cubic-bezier(.4,0,.2,1);
      --color-danger: #ef4444; --color-warning: #f59e0b; --color-success: #10b981;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;background:linear-gradient(135deg,#0f172a 0%,#1e293b 25%,#334155 50%,#1e293b 75%,#0f172a 100%);background-attachment:fixed;color:var(--quantum-text);font-family:'Inter',system-ui,sans-serif;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;background:
      radial-gradient(circle at 20% 80%, rgba(34,197,94,.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(34,197,94,.05) 0%, transparent 50%),
      radial-gradient(circle at 40% 40%, rgba(59,130,246,.05) 0%, transparent 50%);pointer-events:none;z-index:-1}
    .container{max-width:1400px;margin:0 auto;padding:40px 24px;min-height:100vh}
    .header-row{text-align:center;margin-bottom:40px;position:relative}
    h1{font-size:clamp(2.5rem,5vw,4rem);font-weight:900;background:linear-gradient(135deg,var(--quantum-accent),#16a34a,#15803d);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:16px;letter-spacing:-.02em}
    
    /* Filter Section */
    .filter-section{
      background:var(--quantum-surface);
      backdrop-filter:blur(20px);
      border:1px solid var(--quantum-border);
      border-radius:var(--border-radius);
      padding:32px;
      margin-bottom:24px;
      box-shadow:var(--shadow-quantum);
      position:relative;
    }
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:16px}
    .filter-item label{color:var(--quantum-text);font-weight:600;font-size:.875rem;margin-bottom:8px;display:block}

    /* Custom Select Styling */
    .custom-select {
      background: rgba(51, 65, 85, 0.8) !important;
      border: 1px solid var(--quantum-border) !important;
      border-radius: 12px !important;
      color: var(--quantum-text) !important;
      font-size: 0.875rem !important;
      padding: 12px 16px !important;
      min-height: 48px !important;
      width: 100% !important;
      backdrop-filter: blur(10px) !important;
      transition: all 0.2s ease !important;
      appearance: none !important;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23f8fafc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") !important;
      background-repeat: no-repeat !important;
      background-position: right 12px center !important;
      background-size: 16px !important;
    }

    .custom-select:hover {
      border-color: var(--quantum-accent) !important;
      background: rgba(51, 65, 85, 0.9) !important;
    }

    .custom-select:focus {
      border-color: var(--quantum-accent) !important;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2) !important;
      background: rgba(51, 65, 85, 0.9) !important;
      outline: none !important;
    }

    .custom-select:disabled {
      opacity: 0.5 !important;
      cursor: not-allowed !important;
    }

    .custom-select option {
      background: var(--quantum-primary) !important;
      color: var(--quantum-text) !important;
      padding: 8px !important;
    }

    /* Button Styling */
    .filter-button {
      background: linear-gradient(135deg, var(--quantum-accent), var(--quantum-accent-dark)) !important;
      border: none !important;
      border-radius: 12px !important;
      color: white !important;
      font-size: 0.875rem !important;
      font-weight: 600 !important;
      padding: 12px 24px !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      min-height: 48px !important;
    }

    .filter-button:hover:not(:disabled) {
      transform: translateY(-1px) !important;
      box-shadow: 0 8px 25px -8px rgba(34, 197, 94, 0.4) !important;
    }

    .filter-button:disabled {
      opacity: 0.5 !important;
      cursor: not-allowed !important;
      transform: none !important;
      box-shadow: none !important;
    }

    /* Loading indicator */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: var(--border-radius);
      z-index: 100000;
      backdrop-filter: blur(4px);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(34, 197, 94, 0.3);
      border-radius: 50%;
      border-top-color: var(--quantum-accent);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 12px;
      color: var(--quantum-text);
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* Filter instructions */
    .filter-instructions {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 16px;
      font-size: 0.875rem;
      color: var(--quantum-text-muted);
    }

    .filter-instructions strong {
      color: var(--quantum-accent);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--quantum-surface);
      border: 1px solid var(--quantum-border);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow-quantum);
      position: relative;
      transition: var(--transition);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      background: linear-gradient(90deg, var(--quantum-accent), var(--quantum-accent-dark));
    }

    .stat-card.warning::before {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .stat-card.danger::before {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .stat-card-title {
      font-weight: 600;
      color: var(--quantum-text-muted);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-icon {
      font-size: 1.5rem;
      opacity: 0.7;
    }

    .stat-card-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--quantum-text);
      margin-bottom: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .stat-card.warning .stat-card-value {
      color: #f59e0b;
    }

    .stat-card.danger .stat-card-value {
      color: #ef4444;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--quantum-accent), var(--quantum-accent-dark));
      border-radius: 4px;
      transition: width 0.6s ease;
      position: relative;
    }

    .progress-fill.warning {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .progress-fill.danger {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .stat-card-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: var(--quantum-text-muted);
    }

    .stat-value {
      font-weight: 600;
      color: var(--quantum-text);
    }

    /* Map Section */
    .map-section {
      background: var(--quantum-surface);
      border: 1px solid var(--quantum-border);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow-quantum);
      margin-bottom: 32px;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }

    .map-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--quantum-text);
    }

    .map-container {
      height: 500px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--quantum-border);
      position: relative;
    }

    /* Perceel Info Panel */
    .perceel-info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 300px;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid var(--quantum-border);
      border-radius: 12px;
      padding: 20px;
      display: none;
      z-index: 1000;
      box-shadow: var(--shadow-quantum);
    }

    .perceel-info-title {
      font-weight: 700;
      color: var(--quantum-accent);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }

    .perceel-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.875rem;
    }

    .perceel-info-label {
      color: var(--quantum-text-muted);
      font-weight: 500;
    }

    .perceel-info-value {
      color: var(--quantum-text);
      font-weight: 600;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .perceel-close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      color: var(--quantum-text-muted);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 4px;
    }

    /* Bemestingen Table */
    .bemestingen-section {
      background: var(--quantum-surface);
      border: 1px solid var(--quantum-border);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow-quantum);
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--quantum-accent);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid rgba(51, 65, 85, 0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(51, 65, 85, 0.2);
    }

    th {
      background: rgba(51, 65, 85, 0.5);
      color: var(--quantum-text);
      font-weight: 600;
      font-size: 0.875rem;
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }

    td {
      padding: 12px;
      color: var(--quantum-text-muted);
      font-size: 0.875rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.2);
    }

    tr:hover {
      background: rgba(34, 197, 94, 0.05);
    }

    .numeric-value {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-weight: 600;
      color: var(--quantum-text);
    }

    /* No Data States */
    .no-data {
      text-align: center;
      padding: 60px 20px;
      background: var(--quantum-surface);
      border-radius: var(--border-radius);
      border: 2px dashed var(--quantum-border);
      backdrop-filter: blur(20px);
      color: var(--quantum-text-muted);
    }

    .no-data h3 {
      color: var(--quantum-text);
      margin-bottom: 12px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .perceel-info-panel {
        position: relative;
        top: auto;
        right: auto;
        width: 100%;
        margin-top: 16px;
      }
      
      .map-container {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <!-- Quantum Navigation -->
  <nav id="quantumNav"
       data-component="QuantumNavigation"
       data-auto-init="true"
       data-current-page="dashboard"
       data-admin-only="{{ 'true' if session.get('is_admin',0)==1 else 'false' }}"
       data-show-user-profile="true">
    <button class="quantum-mobile-btn" id="quantumMobileBtn" aria-label="Menu"></button>
    <span class="quantum-page-label" id="quantumPageLabel" aria-current="page"></span>
    <ul class="quantum-nav-links" id="quantumNavLinks"></ul>
  </nav>

  <div class="container">
    <!-- Header -->
    <div class="header-row">
      <h1>📊 Bedrijfsdashboard</h1>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <h3 style="color: var(--quantum-accent); margin-bottom: 20px; font-weight: 600;">🔍 Selecteer bedrijf en jaar</h3>
      
      <!-- WERKENDE HTML FORM -->
      <form method="GET" action="{{ url_for('dashboard.bedrijfsdashboard') }}" id="filterForm">
        <div class="filter-grid">
          <div class="filter-item">
            <label for="bedrijf_select">🏢 Bedrijf</label>
            <select id="bedrijf_select" 
                    name="bedrijf_id" 
                    required
                    class="custom-select">
              <option value="">Selecteer een bedrijf...</option>
              {% for bedrijf in bedrijven %}
                <option value="{{ bedrijf.id }}" 
                        {% if bedrijf.id == selected_bedrijf_id %}selected{% endif %}>
                  {{ bedrijf.naam }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-item">
            <label for="jaar_select">📅 Jaar (Gebruiksnormen)</label>
            <select id="jaar_select" 
                    name="jaar" 
                    required 
                    class="custom-select"
                    {% if not selected_bedrijf_id %}disabled{% endif %}>
              <option value="">Selecteer een jaar...</option>
              {% for jaar in jaren %}
                <option value="{{ jaar }}" 
                        {% if jaar == selected_jaar %}selected{% endif %}>
                  {{ jaar }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <button type="submit" 
                  id="filterButton"
                  class="filter-button"
                  disabled>
            📊 Dashboard Laden
          </button>
        </div>
      </form>

      {% if not selected_bedrijf_id %}
      <div class="filter-instructions">
        <strong>📋 Instructies:</strong> Selecteer eerst een bedrijf en daarna het gewenste jaar uit de gebruiksnormen om het dashboard te laden.
      </div>
      {% endif %}

      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center;">
          <div class="loading-spinner"></div>
          <div class="loading-text">Dashboard wordt geladen...</div>
        </div>
      </div>
    </div>

    {% if selected_bedrijf_id and selected_jaar %}
    <!-- Stats Cards -->
    <div class="stats-grid">
      <!-- Totale Stikstof -->
      <div class="stat-card {% if stikstof_total >= stikstof_norm %}danger{% elif stikstof_total >= 0.9*stikstof_norm %}warning{% endif %}">
        <div class="stat-card-header">
          <div class="stat-card-title">🌱 Totale Stikstof</div>
          <div class="stat-card-icon">N</div>
        </div>
        <div class="stat-card-value">{{ stikstof_norm|round(1) }} kg</div>
        <div class="progress-bar">
          <div class="progress-fill {% if stikstof_total >= stikstof_norm %}danger{% elif stikstof_total >= 0.9*stikstof_norm %}warning{% endif %}"
               style="width: {{ (stikstof_total / stikstof_norm * 100)|round(1) if stikstof_norm else 0 }}%"></div>
        </div>
        <div class="stat-card-details">
          <span>Opgebracht: <span class="stat-value">{{ stikstof_total|round(1) }} kg</span></span>
          <span>Resterend: <span class="stat-value">{{ (stikstof_norm - stikstof_total)|round(1) }} kg</span></span>
        </div>
      </div>

      <!-- Dierlijke Stikstof -->
      <div class="stat-card {% if stikstof_dierlijk_total >= stikstof_dierlijk_norm %}danger{% elif stikstof_dierlijk_total >= 0.9*stikstof_dierlijk_norm %}warning{% endif %}">
        <div class="stat-card-header">
          <div class="stat-card-title">🐄 Dierlijke Stikstof</div>
          <div class="stat-card-icon">N</div>
        </div>
        <div class="stat-card-value">{{ stikstof_dierlijk_norm|round(1) }} kg</div>
        <div class="progress-bar">
          <div class="progress-fill {% if stikstof_dierlijk_total >= stikstof_dierlijk_norm %}danger{% elif stikstof_dierlijk_total >= 0.9*stikstof_dierlijk_norm %}warning{% endif %}"
               style="width: {{ (stikstof_dierlijk_total / stikstof_dierlijk_norm * 100)|round(1) if stikstof_dierlijk_norm else 0 }}%"></div>
        </div>
        <div class="stat-card-details">
          <span>Opgebracht: <span class="stat-value">{{ stikstof_dierlijk_total|round(1) }} kg</span></span>
          <span>Resterend: <span class="stat-value">{{ (stikstof_dierlijk_norm - stikstof_dierlijk_total)|round(1) }} kg</span></span>
        </div>
      </div>

      <!-- Fosfaat -->
      <div class="stat-card {% if fosfaat_total >= fosfaat_norm %}danger{% elif fosfaat_total >= 0.9*fosfaat_norm %}warning{% endif %}">
        <div class="stat-card-header">
          <div class="stat-card-title">🧪 Fosfaat</div>
          <div class="stat-card-icon">P</div>
        </div>
        <div class="stat-card-value">{{ fosfaat_norm|round(1) }} kg</div>
        <div class="progress-bar">
          <div class="progress-fill {% if fosfaat_total >= fosfaat_norm %}danger{% elif fosfaat_total >= 0.9*fosfaat_norm %}warning{% endif %}"
               style="width: {{ (fosfaat_total / fosfaat_norm * 100)|round(1) if fosfaat_norm else 0 }}%"></div>
        </div>
        <div class="stat-card-details">
          <span>Opgebracht: <span class="stat-value">{{ fosfaat_total|round(1) }} kg</span></span>
          <span>Resterend: <span class="stat-value">{{ (fosfaat_norm - fosfaat_total)|round(1) }} kg</span></span>
        </div>
      </div>

      <!-- Efficiency Score -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">📈 Efficiëntie Score</div>
          <div class="stat-card-icon">%</div>
        </div>
        <div class="stat-card-value">
          {{ ((stikstof_total / stikstof_norm * 100) if stikstof_norm else 0)|round(0) }}%
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{ ((stikstof_total / stikstof_norm * 100) if stikstof_norm else 0)|round(1) }}%"></div>
        </div>
        <div class="stat-card-details">
          <span>Gebruikt van toegestaan</span>
        </div>
      </div>
    </div>

    <!-- Map Section -->
    <div class="map-section">
      <div class="map-header">
        <div class="map-title">🗺️ Percelen Overzicht</div>
        <div style="color: var(--quantum-text-muted); font-size: 0.875rem;">
          Klik op een perceel voor details
        </div>
      </div>
      
      <div class="map-container">
        <div id="dashboardMap" style="height: 100%; width: 100%;"></div>
        
        <!-- Perceel Info Panel -->
        <div id="perceelInfoPanel" class="perceel-info-panel">
          <button class="perceel-close-btn" onclick="closePerceelInfo()">×</button>
          <div class="perceel-info-title" id="perceelInfoTitle">Perceel Details</div>
          <div id="perceelInfoContent">
            <!-- Content wordt via JavaScript gevuld -->
          </div>
        </div>
      </div>
    </div>

    <!-- Bemestingen Table -->
    <div class="bemestingen-section">
      <div class="section-title">📋 Detailoverzicht Bemestingen</div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>📅 Datum</th>
              <th>📏 Perceel</th>
              <th>🌾 Gewas</th>
              <th>🧪 Meststof</th>
              <th>📐 Oppervlakte (ha)</th>
              <th>⚡ Werking (%)</th>
              <th>🌱 Effectieve N (kg)</th>
              <th>🐄 Effectieve N dierlijk (kg)</th>
              <th>🧪 Effectieve P₂O₅ (kg)</th>
            </tr>
          </thead>
          <tbody>
            {% for b in bemestingen_details %}
              <tr>
                <td>{{ b['datum'] }}</td>
                <td>{{ b['perceel'] }}</td>
                <td>{{ b['gewas'] }}</td>
                <td>{{ b['meststof'] }}</td>
                <td class="numeric-value">{{ b['oppervlakte'] }}</td>
                <td class="numeric-value">{{ b['werkingscoeff'] }}%</td>
                <td class="numeric-value">{{ b['effectieve_n']|round(2) }}</td>
                <td class="numeric-value">{{ b['effectieve_n_dier']|round(2) }}</td>
                <td class="numeric-value">{{ b['effectieve_p2o5']|round(2) }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="9" style="text-align: center; color: var(--quantum-text-muted); padding: 40px;">
                  Geen bemestingen gevonden voor deze selectie
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% else %}
    <!-- No Selection State -->
    <div class="no-data">
      <h3>📊 Selecteer een bedrijf en jaar</h3>
      <p>Kies een bedrijf en jaar om het dashboard te laden.</p>
    </div>
    {% endif %}
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='js/quantum-navigation.js') }}"></script>
  
  <!-- Flask routes -->
  <script>
    window.setFlaskUrls?.({
      'dashboard.bedrijfsdashboard': '{{ url_for("dashboard.bedrijfsdashboard") }}',
      'bemestingen.bemestingen_nieuw': '{{ url_for("bemestingen.bemestingen_nieuw") }}',
      'bedrijven.bedrijven': '{{ url_for("bedrijven.bedrijven") }}',
      'percelen.percelen': '{{ url_for("percelen.percelen") }}',
      'gebruiksnormen.gebruiksnormen': '{{ url_for("gebruiksnormen.gebruiksnormen") }}',
      'universele_data.universele_data': '{{ url_for("universele_data.universele_data") }}',
      'bemestingen.bemestingen': '{{ url_for("bemestingen.bemestingen") }}',
      'gebruikers.gebruikers': '{{ url_for("gebruikers.gebruikers") }}',
      'gebruikers.logout': '{{ url_for("gebruikers.logout") }}'
    });
  </script>

  <!-- WERKENDE DASHBOARD JAVASCRIPT -->
  <script>
    // Simple Dashboard Manager - VOLLEDIG WERKEND
    const SimpleDashboardManager = {
      init() {
        console.log('Initializing Simple Dashboard Manager');
        this.setupFilterLogic();
        this.hideLoading();
        if (this.hasDataToShow()) {
          this.initMap();
        }
      },

      setupFilterLogic() {
        const bedrijfSelect = document.getElementById('bedrijf_select');
        const jaarSelect = document.getElementById('jaar_select');
        const filterButton = document.getElementById('filterButton');
        const filterForm = document.getElementById('filterForm');

        // Bedrijf change handler
        bedrijfSelect.addEventListener('change', () => {
          const bedrijfId = bedrijfSelect.value;
          console.log('Bedrijf selected:', bedrijfId);
          
          if (bedrijfId) {
            // Enable jaar dropdown
            jaarSelect.disabled = false;
            jaarSelect.style.opacity = '1';
            
            // Reset jaar selection
            jaarSelect.value = '';
            this.updateFilterButton();
            
            console.log('Jaar dropdown enabled');
          } else {
            // Disable jaar dropdown
            jaarSelect.disabled = true;
            jaarSelect.style.opacity = '0.5';
            jaarSelect.value = '';
            this.updateFilterButton();
          }
        });

        // Jaar change handler
        jaarSelect.addEventListener('change', () => {
          const jaar = jaarSelect.value;
          console.log('Jaar selected:', jaar);
          this.updateFilterButton();
        });

        // Form submit handler
        filterForm.addEventListener('submit', (e) => {
          const bedrijfId = bedrijfSelect.value;
          const jaar = jaarSelect.value;
          
          if (!bedrijfId || !jaar) {
            e.preventDefault();
            alert('Selecteer zowel een bedrijf als een jaar.');
            return;
          }
          
          console.log('Form submitting with:', { bedrijfId, jaar });
          this.showLoading();
        });

        // Initial state
        this.updateFilterButton();
        
        // Als er al een bedrijf geselecteerd is, enable jaar dropdown
        if (bedrijfSelect.value) {
          jaarSelect.disabled = false;
          jaarSelect.style.opacity = '1';
        }
      },

      updateFilterButton() {
        const bedrijfSelect = document.getElementById('bedrijf_select');
        const jaarSelect = document.getElementById('jaar_select');
        const filterButton = document.getElementById('filterButton');
        
        const bedrijfId = bedrijfSelect.value;
        const jaar = jaarSelect.value;
        
        if (bedrijfId && jaar) {
          filterButton.disabled = false;
        } else {
          filterButton.disabled = true;
        }
      },

      showLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      },

      hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      },

      hasDataToShow() {
        return {{ 'true' if selected_bedrijf_id and selected_jaar else 'false' }};
      },

      // Map Functions
      initMap() {
        const percelen = {{ percelen_data|tojson if percelen_data else '[]' }};
        const bemestingen = {{ bemestingen_details|tojson if bemestingen_details else '[]' }};
        
        if (!percelen || percelen.length === 0) {
          console.log('No percelen data available');
          return;
        }

        console.log('Initializing map with percelen:', percelen.length);

        const netherlands = { lat: 52.1326, lng: 5.2913 };
        
        const map = new google.maps.Map(document.getElementById('dashboardMap'), {
          zoom: 12,
          center: netherlands,
          mapTypeId: google.maps.MapTypeId.SATELLITE,
          styles: [{ featureType: "all", elementType: "labels", stylers: [{ visibility: "on" }] }],
          mapTypeControl: true,
          mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
            position: google.maps.ControlPosition.TOP_CENTER
          }
        });

        this.loadPercelen(map, percelen, bemestingen);
      },

      loadPercelen(map, percelen, bemestingen) {
        const bounds = new google.maps.LatLngBounds();
        let hasValidPercelen = false;

        percelen.forEach(perceel => {
          if (!perceel.polygon_coordinates) return;

          try {
            let coordinates;
            if (typeof perceel.polygon_coordinates === 'string') {
              coordinates = JSON.parse(perceel.polygon_coordinates);
            } else {
              coordinates = perceel.polygon_coordinates;
            }

            if (!Array.isArray(coordinates) || coordinates.length < 3) return;

            const polygonPath = coordinates.map(coord => ({
              lat: parseFloat(coord.lat),
              lng: parseFloat(coord.lng)
            }));

            // Bepaal kleur op basis van efficiency
            const efficiency = this.calculatePerceelEfficiency(perceel, bemestingen);
            let fillColor = '#22c55e';  // groen (goed)
            let strokeColor = '#16a34a';
            
            if (efficiency >= 100) {
              fillColor = '#ef4444';  // rood (over limiet)
              strokeColor = '#dc2626';
            } else if (efficiency >= 90) {
              fillColor = '#f59e0b';  // oranje (waarschuwing)
              strokeColor = '#d97706';
            }

            const polygon = new google.maps.Polygon({
              paths: polygonPath,
              fillColor: fillColor,
              fillOpacity: 0.4,
              strokeColor: strokeColor,
              strokeOpacity: 0.8,
              strokeWeight: 2,
              clickable: true
            });

            polygon.setMap(map);

            // Click listener
            polygon.addListener('click', () => {
              this.showPerceelInfo(perceel, bemestingen);
            });

            // Extend bounds
            polygonPath.forEach(coord => bounds.extend(coord));
            hasValidPercelen = true;

          } catch (error) {
            console.error('Error loading perceel polygon:', error);
          }
        });

        if (hasValidPercelen) {
          map.fitBounds(bounds);
        }
      },

      calculatePerceelEfficiency(perceel, bemestingen) {
        const perceelBemestingen = bemestingen.filter(b => 
          b.perceel === perceel.perceelnaam
        );
        
        const totalN = perceelBemestingen.reduce((sum, b) => sum + (b.effectieve_n || 0), 0);
        const norm = (perceel.stikstof_norm_kg_ha || 0) * (perceel.oppervlakte || 0);
        
        return norm > 0 ? (totalN / norm * 100) : 0;
      },

      showPerceelInfo(perceel, bemestingen) {
        const panel = document.getElementById('perceelInfoPanel');
        const title = document.getElementById('perceelInfoTitle');
        const content = document.getElementById('perceelInfoContent');

        title.textContent = perceel.perceelnaam || 'Onbekend Perceel';

        // Bereken totalen voor dit perceel
        const perceelBemestingen = bemestingen.filter(b => 
          b.perceel === perceel.perceelnaam
        );

        const totalN = perceelBemestingen.reduce((sum, b) => sum + (b.effectieve_n || 0), 0);
        const totalNDierlijk = perceelBemestingen.reduce((sum, b) => sum + (b.effectieve_n_dier || 0), 0);
        const totalP2O5 = perceelBemestingen.reduce((sum, b) => sum + (b.effectieve_p2o5 || 0), 0);

        const stikstofNorm = (perceel.stikstof_norm_kg_ha || 0) * (perceel.oppervlakte || 0);
        const stikstofDierlijkNorm = (perceel.stikstof_dierlijk_kg_ha || 0) * (perceel.oppervlakte || 0);
        const fosfaatNorm = (perceel.fosfaat_norm_kg_ha || 0) * (perceel.oppervlakte || 0);

        content.innerHTML = `
          <div class="perceel-info-item">
            <span class="perceel-info-label">📐 Oppervlakte:</span>
            <span class="perceel-info-value">${(perceel.oppervlakte || 0).toFixed(2)} ha</span>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">🌾 Gewas:</span>
            <span class="perceel-info-value">${perceel.gewas || 'Onbekend'}</span>
          </div>
          
          <div style="margin: 16px 0; padding-top: 12px; border-top: 1px solid rgba(51,65,85,.5);">
            <strong style="color: var(--quantum-accent); font-size: 0.875rem;">🌱 Stikstof Totaal</strong>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Norm:</span>
            <span class="perceel-info-value">${stikstofNorm.toFixed(1)} kg</span>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Opgebracht:</span>
            <span class="perceel-info-value">${totalN.toFixed(1)} kg</span>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Resterend:</span>
            <span class="perceel-info-value" style="color: ${(stikstofNorm - totalN) < 0 ? '#ef4444' : '#22c55e'}">${(stikstofNorm - totalN).toFixed(1)} kg</span>
          </div>
          
          <div style="margin: 16px 0; padding-top: 12px; border-top: 1px solid rgba(51,65,85,.5);">
            <strong style="color: var(--quantum-accent); font-size: 0.875rem;">🐄 Dierlijke Stikstof</strong>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Norm:</span>
            <span class="perceel-info-value">${stikstofDierlijkNorm.toFixed(1)} kg</span>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Opgebracht:</span>
            <span class="perceel-info-value">${totalNDierlijk.toFixed(1)} kg</span>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Resterend:</span>
            <span class="perceel-info-value" style="color: ${(stikstofDierlijkNorm - totalNDierlijk) < 0 ? '#ef4444' : '#22c55e'}">${(stikstofDierlijkNorm - totalNDierlijk).toFixed(1)} kg</span>
          </div>
          
          <div style="margin: 16px 0; padding-top: 12px; border-top: 1px solid rgba(51,65,85,.5);">
            <strong style="color: var(--quantum-accent); font-size: 0.875rem;">🧪 Fosfaat</strong>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Norm:</span>
            <span class="perceel-info-value">${fosfaatNorm.toFixed(1)} kg</span>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Opgebracht:</span>
            <span class="perceel-info-value">${totalP2O5.toFixed(1)} kg</span>
          </div>
          <div class="perceel-info-item">
            <span class="perceel-info-label">Resterend:</span>
            <span class="perceel-info-value" style="color: ${(fosfaatNorm - totalP2O5) < 0 ? '#ef4444' : '#22c55e'}">${(fosfaatNorm - totalP2O5).toFixed(1)} kg</span>
          </div>
          
          <div style="margin: 16px 0; padding-top: 12px; border-top: 1px solid rgba(51,65,85,.5);">
            <strong style="color: var(--quantum-accent); font-size: 0.875rem;">📋 Bemestingen (${perceelBemestingen.length})</strong>
          </div>
          ${perceelBemestingen.slice(0, 3).map(b => `
            <div style="margin: 8px 0; padding: 8px; background: rgba(51,65,85,.3); border-radius: 6px; font-size: 0.75rem;">
              <div style="font-weight: 600; color: var(--quantum-text);">${b.datum} - ${b.meststof}</div>
              <div style="color: var(--quantum-text-muted);">N: ${(b.effectieve_n || 0).toFixed(1)}kg, P: ${(b.effectieve_p2o5 || 0).toFixed(1)}kg</div>
            </div>
          `).join('')}
          ${perceelBemestingen.length > 3 ? `<div style="text-align: center; color: var(--quantum-text-muted); font-size: 0.75rem; margin-top: 8px;">...en ${perceelBemestingen.length - 3} meer</div>` : ''}
        `;

        panel.style.display = 'block';
      }
    };

    // Global functions
    function closePerceelInfo() {
      const panel = document.getElementById('perceelInfoPanel');
      if (panel) {
        panel.style.display = 'none';
      }
    }

    function initMaps() {
      SimpleDashboardManager.initMap();
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      SimpleDashboardManager.init();
    });
  </script>
</body>
</html>