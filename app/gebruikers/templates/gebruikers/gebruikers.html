{% if session.get('is_admin', 0) == 1 %}
<!DOCTYPE html>
<html lang="nl">
<head>
  {% set _display_name = session.get('view_as_user_name')
                      or session.get('naam')
                      or session.get('username')
                      or 'Gebruiker' %}
  <meta charset="UTF-8" />
  <title>üë• Gebruikersbeheer - AgriTech 2100</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Quantum Navigation CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quantum-navigation.css') }}">

  <!-- Choices.js (voor filters) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>

  <!-- Herbruikbare filter-styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css') }}">

  <!-- Quantum Modal (vervangt oude modal CSS) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quantum-modal.css') }}">

  <style>
    /* ====== Pagina-styling (beperkt tot layout/kaarten) ====== */
    :root {
      --quantum-primary:#0f172a;--quantum-secondary:#1e293b;--quantum-accent:#22c55e;--quantum-accent-dark:#16a34a;
      --quantum-surface:rgba(30,41,59,.8);--quantum-surface-light:rgba(51,65,85,.6);--quantum-text:#f8fafc;--quantum-text-muted:rgba(248,250,252,.7);
      --quantum-border:rgba(34,197,94,.2);--shadow-quantum:0 25px 50px -12px rgba(0,0,0,.4);--shadow-glow:0 0 20px rgba(34,197,94,.1);
      --border-radius:16px;--transition:all .3s cubic-bezier(.4,0,.2,1)
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;background:linear-gradient(135deg,#0f172a 0%,#1e293b 25%,#334155 50%,#1e293b 75%,#0f172a 100%);background-attachment:fixed;color:var(--quantum-text);font-family:'Inter',system-ui,sans-serif;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;background:
      radial-gradient(circle at 20% 80%, rgba(34,197,94,.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(34,197,94,.05) 0%, transparent 50%),
      radial-gradient(circle at 40% 40%, rgba(59,130,246,.05) 0%, transparent 50%);pointer-events:none;z-index:-1}
    .container{max-width:1400px;margin:0 auto;padding:40px 24px;min-height:100vh}
    .header-row{text-align:center;margin-bottom:40px;position:relative}
    h1{font-size:clamp(2.5rem,5vw,4rem);font-weight:900;background:linear-gradient(135deg,var(--quantum-accent),#16a34a,#15803d);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:16px;letter-spacing:-.02em}
    .top-actions{display:flex;gap:16px;justify-content:center;margin-bottom:24px;flex-wrap:wrap}
    .action-btn{background:linear-gradient(135deg,var(--quantum-accent),var(--quantum-accent-dark));color:#fff;border:0;padding:12px 24px;border-radius:12px;font-weight:600;font-size:.875rem;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden;display:inline-flex;align-items:center;gap:8px}
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(34,197,94,.3)}

    .filter-section{background:var(--quantum-surface);backdrop-filter:blur(20px);border:1px solid var(--quantum-border);border-radius:var(--border-radius);padding:32px;margin-bottom:12px;box-shadow:var(--shadow-quantum);position:relative}
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:16px}
    .filter-item label{color:var(--quantum-text);font-weight:600;font-size:.875rem;margin-bottom:8px;display:block}
    .filter-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .btn-filter,.btn-reset{padding:12px 24px;border:0;border-radius:12px;cursor:pointer;font-weight:600;font-size:.875rem;transition:var(--transition)}
    .btn-filter{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
    .btn-reset{background:var(--quantum-surface-light);color:var(--quantum-text);border:1px solid var(--quantum-border)}

    .modern-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:24px}
    .data-card{background:var(--quantum-surface);border:1px solid var(--quantum-border);border-radius:var(--border-radius);padding:24px;box-shadow:var(--shadow-quantum);transition:var(--transition);position:relative}
    .data-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--quantum-accent),var(--quantum-accent-dark))}
    .card-header{display:flex;justify-content:space-between;gap:16px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(51,65,85,.5)}
    .card-title{font-weight:700;color:var(--quantum-text);font-size:1.2rem}
    .card-content{display:grid;grid-template-columns:1fr 1fr;gap:16px 24px;margin-bottom:20px}
    .card-label{font-weight:600;color:var(--quantum-text-muted);font-size:.75rem;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
    .card-value{color:var(--quantum-text);font-weight:500}
    .card-value.admin-badge{background:linear-gradient(135deg,rgba(34,197,94,.2),rgba(16,163,74,.2));color:var(--quantum-accent);padding:4px 8px;border-radius:6px;display:inline-block;font-weight:700}
    .card-value.user-badge{background:rgba(59,130,246,.1);color:#3b82f6;padding:4px 8px;border-radius:6px;display:inline-block;font-weight:700}
    .card-actions{display:flex;gap:12px;justify-content:center;padding-top:20px;border-top:1px solid rgba(51,65,85,.5);flex-wrap:wrap}
    .card-actions button{background:var(--quantum-surface-light);border:1px solid var(--quantum-border);color:var(--quantum-text);border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;font-size:.85rem;transition:var(--transition)}
    .card-actions .danger-btn{background:rgba(239,68,68,.1);color:#ef4444;border-color:rgba(239,68,68,.3)}
    .card-actions .admin-btn{background:rgba(34,197,94,.1);color:var(--quantum-accent);border-color:rgba(34,197,94,.3)}
    .no-data,.no-results-filter{text-align:center;padding:60px 20px;background:var(--quantum-surface);border-radius:var(--border-radius);border:2px dashed var(--quantum-border);backdrop-filter:blur(20px)}
      
  </style>
</head>
<body>
  <!-- Quantum Navigation (auto-init via data-attrs) -->
<nav id="quantumNav"
     data-component="QuantumNavigation"
     data-auto-init="true"
     data-current-page="gebruikers"
     data-admin-only="{{ 'true' if session.get('is_admin',0)==1 else 'false' }}"
     data-show-user-profile="true"
     data-user-name="{{ _display_name }}"
     data-user-avatar="{{ _display_name[0]|upper }}"
     data-user-role="{{ 'Admin' if session.get('is_admin',0)==1 else 'Gebruiker' }}">
  <button class="quantum-mobile-btn" id="quantumMobileBtn" aria-label="Menu"></button>
  <span class="quantum-page-label" id="quantumPageLabel" aria-current="page"></span>
  <ul class="quantum-nav-links" id="quantumNavLinks"></ul>
</nav>

  <div class="container">
    <!-- Header -->
    <div class="header-row">
      <h1 id="pageTitle" class="sidebar-title"></h1>
      <div class="top-actions">
        <button class="action-btn" onclick="openAddDialog()">‚ú® Nieuwe gebruiker</button>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="flash flash-{{category}}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- Filter Section -->
    <div class="filter-section">
      <h3>üîç Filter gebruikers</h3>

      <div class="filter-grid">
        <div class="filter-item">
          <label for="filter-naam">üë§ Naam</label>
          <select id="filter-naam" data-placeholder="Kies naam...">
            <option value=""></option>
          </select>
        </div>
        <div class="filter-item">
          <label for="filter-admin">üõ°Ô∏è Admin Status</label>
          <select id="filter-admin" data-placeholder="Alle statussen...">
            <option value=""></option>
            <option value="1">Admin</option>
            <option value="0">Gebruiker</option>
          </select>
        </div>
        <div class="filter-item">
          <label for="filter-username">üÜî Gebruikersnaam</label>
          <select id="filter-username" data-placeholder="Kies gebruikersnaam...">
            <option value=""></option>
          </select>
        </div>
      </div>

      <div id="active-filters" class="active-filters"></div>

      <div class="filter-buttons">
        <button type="button" id="btn-reset" class="btn-reset">üîÑ Reset alle filters</button>
        <button type="button" id="btn-export" class="btn-filter">üìä Exporteer gefilterde data</button>
      </div>
    </div>

    <!-- Data -->
    <div class="data-container">
      {% if gebruikers %}
      <div class="modern-grid" id="gebruikers-grid">
        {% for u in gebruikers %}
        <div class="data-card"
             data-id="{{ u['id'] }}"
             data-naam="{{ (u['naam'] or u['username'])|e }}"
             data-username="{{ u['username']|e }}"
             data-email="{{ (u['email'] or '')|e }}"
             data-admin="{{ 1 if u['is_admin'] else 0 }}">

          <div class="card-header">
            <div class="card-title">{{ u['naam'] or u['username'] }}</div>
            <div class="card-date">{{ u['email'] or 'Geen email' }}</div>
          </div>

          <div class="card-content">
            <div>
              <div class="card-label">Gebruikersnaam</div>
              <div class="card-value" style="color:var(--quantum-accent);font-weight:700">{{ u['username'] }}</div>
            </div>
            <div>
              <div class="card-label">Volledige naam</div>
              <div class="card-value">{{ u['naam'] or '-' }}</div>
            </div>
            <div>
              <div class="card-label">E-mailadres</div>
              <div class="card-value">{{ u['email'] or '-' }}</div>
            </div>
            <div>
              <div class="card-label">Status</div>
              <div class="card-value {{ 'admin-badge' if u['is_admin'] else 'user-badge' }}">
                {{ 'üõ°Ô∏è Administrator' if u['is_admin'] else 'üë§ Gebruiker' }}
              </div>
            </div>
          </div>

          <div class="card-actions">
            {% if not u['is_admin'] %}
            <form action="{{ url_for('gebruikers.gebruikers_make_admin', user_id=u['id']) }}"
                  method="POST" style="display:inline;">
              <button type="button" class="admin-btn"
                      onclick="confirmMakeAdmin(this, '{{ (u['naam'] or u['username'])|e }}')">üõ°Ô∏è Maak admin</button>
            </form>
            {% else %}
              {% if u['id'] != current_user_id %}
              <form action="{{ url_for('gebruikers.gebruikers_remove_admin', user_id=u['id']) }}"
                    method="POST" style="display:inline;">
                <button type="button" class="danger-btn"
                        onclick="confirmRemoveAdmin(this, '{{ (u['naam'] or u['username'])|e }}')">üö´ Ontneem admin</button>
              </form>
              {% endif %}
            {% endif %}

            <button type="button" class="btn-edit"
                    onclick="openEditDialog(
                      '{{ u['id']|e }}',
                      '{{ u['username']|e }}',
                      '{{ (u['naam'] or '')|e }}',
                      '{{ (u['email'] or '')|e }}'
                    )">‚úèÔ∏è Bewerken</button>

            {% if u['id'] != current_user_id %}
            <form action="{{ url_for('gebruikers.gebruikers_delete', user_id=u['id']) }}"
                  method="POST" style="display:inline;">
              <button type="button" class="danger-btn"
                      onclick="confirmDeleteUser(this, '{{ (u['naam'] or u['username'])|e }}')">üóëÔ∏è Verwijder</button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="no-data">
        <h3>ü§∑‚Äç‚ôÇÔ∏è Geen gebruikers gevonden</h3>
        <p>Er zijn nog geen gebruikers toegevoegd aan het systeem.</p>
        <button onclick="openAddDialog()" class="action-btn">‚ú® Voeg de eerste gebruiker toe</button>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ===== Quantum Modals ===== -->

  <!-- Add Dialog -->
  <div id="addDialog" class="qm-modal" data-static="false">
    <div class="qm-dialog qm-size-sm" role="dialog" aria-modal="true" aria-labelledby="addDialogTitle">
      <button class="qm-close" data-modal-close aria-label="Sluiten">√ó</button>
      <header class="qm-header">
        <h3 class="qm-title" id="addDialogTitle">Nieuwe gebruiker toevoegen</h3>
      </header>
      <section class="qm-body">
        <form id="addForm" method="POST" autocomplete="off" action="{{ url_for('gebruikers.gebruikers_add') }}">
          <label>Gebruikersnaam: <input type="text" name="username" required></label>
          <label>Volledige naam: <input type="text" name="naam"></label>
          <label>E-mailadres: <input type="email" name="email"></label>
          <label>Wachtwoord: <input type="password" name="password" required autocomplete="new-password"></label>
          <label>Admin rechten:
            <select name="is_admin">
              <option value="0" selected>üë§ Standaard gebruiker</option>
              <option value="1">üõ°Ô∏è Administrator</option>
            </select>
          </label>
        </form>
      </section>
      <footer class="qm-footer">
        <button type="button" class="qm-btn qm-btn-secondary" data-modal-close>Annuleren</button>
        <button type="submit" class="qm-btn qm-btn-primary" form="addForm">Toevoegen</button>
      </footer>
    </div>
  </div>

  <!-- Edit Dialog -->
  <div id="editDialog" class="qm-modal" data-static="false">
    <div class="qm-dialog qm-size-sm" role="dialog" aria-modal="true" aria-labelledby="editDialogTitle">
      <button class="qm-close" data-modal-close aria-label="Sluiten">√ó</button>
      <header class="qm-header">
        <h3 class="qm-title" id="editDialogTitle">Gebruiker bewerken</h3>
      </header>
      <section class="qm-body">
        <form id="editForm" method="POST" autocomplete="off">
          <input type="hidden" name="user_id" id="edit_user_id">
          <label>Gebruikersnaam: <input type="text" name="username" id="edit_username" required></label>
          <label>Volledige naam: <input type="text" name="naam" id="edit_naam"></label>
          <label>E-mailadres: <input type="email" name="email" id="edit_email"></label>
          <label>Nieuw wachtwoord (leeg = ongewijzigd):
            <input type="password" name="password" id="edit_password" autocomplete="new-password">
          </label>
        </form>
      </section>
      <footer class="qm-footer">
        <button type="button" class="qm-btn qm-btn-secondary" data-modal-close>Annuleren</button>
        <button type="submit" class="qm-btn qm-btn-primary" form="editForm">Opslaan</button>
      </footer>
    </div>
  </div>

  <!-- Quantum Navigation JavaScript -->
  <script src="{{ url_for('static', filename='js/quantum-navigation.js') }}"></script>

  <!-- Flask routes naar JS brengen v√≥√≥r DOMContentLoaded -->
  <script>
    window.setFlaskUrls?.({
      'dashboard.bedrijfsdashboard': '{{ url_for("dashboard.bedrijfsdashboard") }}',
      'bemestingen.bemestingen_nieuw': '{{ url_for("bemestingen.bemestingen_nieuw") }}',
      'bedrijven.bedrijven': '{{ url_for("bedrijven.bedrijven") }}',
      'percelen.percelen': '{{ url_for("percelen.percelen") }}',
      'gebruiksnormen.gebruiksnormen': '{{ url_for("gebruiksnormen.gebruiksnormen") }}',
      'universele_data.universele_data': '{{ url_for("universele_data.universele_data") }}',
      'bemestingen.bemestingen': '{{ url_for("bemestingen.bemestingen") }}',
      'gebruikers.gebruikers': '{{ url_for("gebruikers.gebruikers") }}',
      'gebruikers.logout': '{{ url_for("gebruikers.logout") }}'
    });
  </script>

  <!-- Herbruikbare filter-logica -->
  <script src="{{ url_for('static', filename='js/filter.js') }}"></script>

  <!-- Quantum Modal JS -->
  <script defer src="{{ url_for('static', filename='js/quantum-modal.js') }}"></script>

  <!-- Pagina-script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const filter = new FilterManager({
        gridSelector: '#gebruikers-grid',
        cardSelector: '.data-card',
        chipContainer: '#active-filters',
        filterSectionSelector: '.filter-section',
        totalAttribute: null,
        populateFromGrid: true,
        selects: [
          { id:'filter-naam', label:'Naam', type:'string', dataAttr:'naam' },
          { id:'filter-username', label:'Gebruikersnaam', type:'string', dataAttr:'username' },
          { id:'filter-admin', label:'Admin', type:'string', dataAttr:'admin',
            transform: (val) => val === '1' ? 'Admin' : val === '0' ? 'Gebruiker' : val }
        ],
        exportFields: {
          'username': 'Gebruikersnaam',
          'naam': 'Volledige naam',
          'email': 'E-mailadres',
          'admin': 'Admin Status'
        },
        exportTransform: {
          'admin': (val) => val === '1' ? 'Ja' : 'Nee'
        }
      });
      filter.init();

      document.getElementById('btn-reset')?.addEventListener('click', ()=> filter.reset());
      document.getElementById('btn-export')?.addEventListener('click', ()=> filter.exportCSV('gebruikers_gefilterd'));
    });

    // ===== Dialog helpers met QuantumModal =====
    function openEditDialog(id, username, naam, email) {
      document.getElementById('edit_user_id').value = id;
      document.getElementById('edit_username').value = username;
      document.getElementById('edit_naam').value = naam || '';
      document.getElementById('edit_email').value = email || '';
      document.getElementById('edit_password').value = '';
      const editUrlTemplate = "{{ url_for('gebruikers.gebruikers_edit', user_id='__ID__') }}";
      document.getElementById('editForm').action = editUrlTemplate.replace('__ID__', id);
      QuantumModal.open('#editDialog');
      setTimeout(() => document.getElementById('edit_username').focus(), 120);
    }
    function openAddDialog() {
      document.getElementById('addForm').reset();
      QuantumModal.open('#addDialog');
      setTimeout(() => document.querySelector("#addDialog input[name='username']").focus(), 120);
    }

    // Confirm-acties
    function confirmMakeAdmin(btn, naam){
      QuantumModal.confirm({
        title: 'Maak admin?',
        message: `Je staat op het punt <b>${naam}</b> administratorrechten te geven.`,
        confirmText: 'üõ°Ô∏è Maak admin',
        cancelText: 'Annuleren'
      }).then(ok => { if(ok) btn.closest('form').submit(); });
    }
    function confirmRemoveAdmin(btn, naam){
      QuantumModal.confirm({
        title: 'Admin-rechten ontneem?',
        message: `Admin-rechten weghalen bij <b>${naam}</b>?`,
        confirmText: 'üö´ Ontneem admin',
        cancelText: 'Annuleren',
        variant: 'danger'
      }).then(ok => { if(ok) btn.closest('form').submit(); });
    }
    function confirmDeleteUser(btn, naam){
      QuantumModal.confirm({
        title: 'Gebruiker verwijderen?',
        message: `Weet je zeker dat je <b>${naam}</b> wilt verwijderen? Dit kan niet ongedaan gemaakt worden.`,
        confirmText: 'üóëÔ∏è Verwijder',
        cancelText: 'Annuleren',
        variant: 'danger'
      }).then(ok => { if(ok) btn.closest('form').submit(); });
    }
  </script>
</body>
</html>
{% else %}
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Geen toegang - AgriTech 2100</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{margin:0;padding:2rem;font-family:system-ui,sans-serif;background:linear-gradient(135deg,#0f172a,#1e293b);color:#f8fafc;min-height:100vh;display:flex;align-items:center;justify-content:center}
    .access-denied{text-align:center;background:rgba(30,41,59,.8);padding:3rem;border-radius:16px;border:1px solid rgba(34,197,94,.2);backdrop-filter:blur(20px)}
    h1{color:#ef4444;margin-bottom:1rem}
    a{color:#22c55e}
  </style>
</head>
<body>
  <div class="access-denied">
    <h1>üö´ Geen toegang</h1>
    <p>Je hebt geen administrator rechten om deze pagina te bekijken.</p>
    <p><a href="{{ url_for('dashboard.bedrijfsdashboard') }}">‚Üê Terug naar dashboard</a></p>
  </div>
</body>
</html>
{% endif %}
